<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานความก้าวหน้าโครงการ - เทศบาลตำบลบ้านแหลม (Interactive)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        
        /* Table Transitions */
        tr.transition-all { transition: all 0.2s ease-in-out; }
        .hidden-row { display: none; }
        .rotate-180 { transform: rotate(180deg); }
        .cursor-pointer:hover { background-color: #f8fafc; }
        
        /* Fade In Animation */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-slate-800">

    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg shadow-lg shadow-blue-900/50">
                    <i class="fa-solid fa-chart-simple"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">ระบบติดตามโครงการ</h1>
                    <p class="text-xs text-slate-400">เทศบาลตำบลบ้านแหลม</p>
                </div>
            </div>
            <label for="csvUpload" class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-xs px-4 py-2 rounded-full text-white transition flex items-center gap-2 shadow-md">
                <i class="fa-solid fa-cloud-arrow-up"></i> อัปเดตข้อมูล CSV
            </label>
            <input type="file" id="csvUpload" accept=".csv" class="hidden" />
        </div>
    </nav>

    <div class="bg-white border-b shadow-sm sticky top-16 z-40">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col lg:flex-row gap-4 items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-slate-500">
                    <i class="fa-solid fa-filter"></i> ตัวกรอง:
                </div>
                <div class="flex flex-wrap gap-2 w-full lg:w-auto">
                    <select id="filterType" onchange="applyFilters()" class="bg-slate-50 border-slate-200 text-sm rounded-lg p-2 focus:ring-blue-500 outline-none border hover:border-blue-400 transition">
                        <option value="all">ทุกประเภท</option>
                        <option value="โครงการ">โครงการ</option>
                        <option value="ครุภัณฑ์">ครุภัณฑ์</option>
                        <option value="กิจกรรม">กิจกรรม</option>
                    </select>
                    
                    <select id="filterDept" onchange="applyFilters()" class="bg-slate-50 border-slate-200 text-sm rounded-lg p-2 focus:ring-blue-500 outline-none border hover:border-blue-400 transition">
                        <option value="all">ทุกหน่วยงาน</option>
                    </select>
                    
                    <select id="filterStatus" onchange="applyFilters()" class="bg-slate-50 border-slate-200 text-sm rounded-lg p-2 focus:ring-blue-500 outline-none border hover:border-blue-400 transition">
                        <option value="all">ทุกสถานะ</option>
                        <option value="completed">เสร็จสิ้น</option>
                        <option value="ongoing">กำลังดำเนินงาน</option>
                        <option value="pending">ยังไม่เริ่ม</option>
                    </select>
                    
                    <button onclick="resetFilters()" class="text-xs text-red-500 hover:text-red-700 underline px-2">ล้างค่า</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6">

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-xs text-slate-500 uppercase font-semibold">จำนวนโครงการ</p>
                <h2 class="text-3xl font-bold text-slate-800 mt-1" id="kpiCount">0</h2>
            </div>
            <div class="card p-5 border-l-4 border-emerald-500">
                <p class="text-xs text-slate-500 uppercase font-semibold">งบประมาณตั้งไว้</p>
                <h2 class="text-3xl font-bold text-slate-800 mt-1" id="kpiBudget">0</h2>
                <p class="text-xs text-slate-400">บาท</p>
            </div>
            <div class="card p-5 border-l-4 border-purple-500">
                <p class="text-xs text-slate-500 uppercase font-semibold">เบิกจ่ายจริง</p>
                <h2 class="text-3xl font-bold text-slate-800 mt-1" id="kpiSpent">0</h2>
                <p class="text-xs text-slate-400">บาท</p>
            </div>
            <div class="card p-5 border-l-4 border-amber-500">
                <p class="text-xs text-slate-500 uppercase font-semibold">% การเบิกจ่าย</p>
                <h2 class="text-3xl font-bold text-slate-800 mt-1" id="kpiPercent">0%</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card p-6 lg:col-span-1">
                <h3 class="font-bold text-slate-700 mb-4 text-center">สถานะงานทั้งหมด</h3>
                <div class="relative h-60 w-full flex justify-center">
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
            <div class="card p-6 lg:col-span-2">
                <h3 class="font-bold text-slate-700 mb-4">งบประมาณแยกตามหน่วยงาน (Top 5)</h3>
                <div class="relative h-60 w-full">
                    <canvas id="chartDept"></canvas>
                </div>
            </div>
        </div>

        <div class="card overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fa-solid fa-list-ul"></i> รายชื่อโครงการและรายละเอียด
                </h3>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                    แสดงผล <span id="showingCount">0</span> รายการ
                </span>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left">
                    <thead class="bg-slate-100 text-slate-600 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-6 py-4 w-[10%]">ประเภท</th>
                            <th class="px-6 py-4 w-[35%]">ชื่อโครงการ / รายการ</th>
                            <th class="px-6 py-4 w-[15%]">หน่วยงาน</th>
                            <th class="px-6 py-4 w-[12%] text-right">งบตั้งไว้</th>
                            <th class="px-6 py-4 w-[12%] text-right">เบิกจ่าย</th>
                            <th class="px-6 py-4 w-[16%] text-center">สถานะ</th>
                            <th class="px-2 py-4 w-[5%]"></th> </tr>
                    </thead>
                    <tbody id="tableBody" class="divide-y divide-slate-200">
                        </tbody>
                </table>
            </div>
            <div class="p-6 text-center text-slate-400 text-sm bg-slate-50/50">
                <i class="fa-solid fa-circle-info mr-1"></i> คลิกที่ชื่อโครงการหรือลูกศร เพื่อดูรายละเอียดเพิ่มเติม
            </div>
        </div>

    </div>

    <script>
        // --- Mock Data ---
        const initialRawData = [
            { 
                ProjectName: "ครุภัณฑ์คอมพิวเตอร์ 2 รายการ", 
                Details: "เครื่องพิมพ์ Multifunction เลเซอร์ หรือ LED สี จำนวน 2 เครื่อง สำหรับงานธุรการ",
                Problems: "",
                Department: "กองคลัง", Budget: 32000, Spent: 32000, Status: "ดำเนินการแล้วเสร็จ" 
            },
            { 
                ProjectName: "ครุภัณฑ์ รถบรรทุกขยะ 6 ตัน 6 ล้อ", 
                Details: "จัดซื้อรถบรรทุกขยะ ขนาด 6 ตัน 6 ล้อ ปริมาตรกระบอกสูบไม่ต่ำกว่า 6,000 ซีซี หรือกำลังเครื่องยนต์สูงสุดไม่ต่ำกว่า 170 กิโลวัตต์ แบบอัดท้าย จำนวน 1 คัน",
                Problems: "ผู้รับจ้างลงนามในสัญญาแล้ว รอส่งมอบ",
                Department: "กองสาธารณสุขฯ", Budget: 2643000, Spent: 0, Status: "อยู่ระหว่างดำเนินงาน" 
            },
            { 
                ProjectName: "โครงการก่อสร้างโรงจอดรถยนต์ (ขยะมูลฝอย)", 
                Details: "ก่อสร้างโรงจอดรถยนต์ ขนาดกว้าง 8.00 เมตร ยาว 40.00 เมตร บริเวณสถานที่กำจัดขยะมูลฝอยของเทศบาล หมู่ที่ 5",
                Problems: "ประกาศวิจารณ์ อยู่ระหว่างรอผล",
                Department: "กองสาธารณสุขฯ", Budget: 2399000, Spent: 0, Status: "อยู่ระหว่างดำเนินงาน" 
            },
            { 
                ProjectName: "โครงการฝึกอบรมเยาวชนคัดแยกขยะ", 
                Details: "จัดกิจกรรมให้ความรู้ความเข้าใจแก่เด็กนักเรียน โรงเรียนอนุบาลวัดต้นสน",
                Problems: "",
                Department: "กองสาธารณสุขฯ", Budget: 14000, Spent: 13120, Status: "ดำเนินการแล้วเสร็จ" 
            },
             { 
                ProjectName: "โครงการปรับปรุงเสริมผิวถนนลาดยาง", 
                Details: "ปรับปรุงผิวถนนหน้าโรงพยาบาลบ้านแหลม หมู่ที่ 3 และ 4",
                Problems: "ผู้รับจ้างเข้างานล่าช้ากว่ากำหนด 3 วัน",
                Department: "กองช่าง", Budget: 2971000, Spent: 0, Status: "อยู่ระหว่างดำเนินการ" 
            }
        ];

        let allData = [];
        let chartStatusInstance = null;
        let chartDeptInstance = null;

        // --- 1. Processing Logic ---
        function processData(rawData) {
            return rawData.map((row, index) => {
                let budget = parseFloat((row.Budget + "").replace(/,/g, '')) || 0;
                let spent = parseFloat((row.Spent + "").replace(/,/g, '')) || 0;
                let name = row.ProjectName || "";
                
                // Auto-Type
                let type = "กิจกรรม";
                if (name.trim().startsWith("โครงการ")) type = "โครงการ";
                else if (name.trim().startsWith("ครุภัณฑ์")) type = "ครุภัณฑ์";

                // Status Group
                let rawStatus = row.Status || "";
                let statusGroup = "pending";
                if (rawStatus.includes("เสร็จ") || rawStatus.includes("เรียบร้อย")) statusGroup = "completed";
                else if (rawStatus.includes("ระหว่าง") || rawStatus.includes("กำลัง")) statusGroup = "ongoing";

                return {
                    id: index,
                    ...row,
                    BudgetVal: budget,
                    SpentVal: spent,
                    Type: type,
                    StatusGroup: statusGroup,
                    DisplayStatus: rawStatus,
                    Details: row.Details || "ไม่มีรายละเอียดระบุ",
                    Problems: row.Problems || "-"
                };
            });
        }

        // --- 2. Filter & Render ---
        function applyFilters() {
            const typeFilter = document.getElementById('filterType').value;
            const deptFilter = document.getElementById('filterDept').value;
            const statusFilter = document.getElementById('filterStatus').value;

            const filtered = allData.filter(item => {
                return ((typeFilter === 'all') || (item.Type === typeFilter)) &&
                       ((deptFilter === 'all') || (item.Department === deptFilter)) &&
                       ((statusFilter === 'all') || (item.StatusGroup === statusFilter));
            });

            updateDashboard(filtered);
        }

        function updateDashboard(data) {
            // Update KPIs
            const totalBudget = data.reduce((sum, item) => sum + item.BudgetVal, 0);
            const totalSpent = data.reduce((sum, item) => sum + item.SpentVal, 0);
            
            document.getElementById('kpiCount').innerText = data.length;
            document.getElementById('kpiBudget').innerText = totalBudget.toLocaleString();
            document.getElementById('kpiSpent').innerText = totalSpent.toLocaleString();
            document.getElementById('kpiPercent').innerText = totalBudget > 0 ? ((totalSpent/totalBudget)*100).toFixed(1)+"%" : "0%";
            document.getElementById('showingCount').innerText = data.length;

            // Render Table with Accordion
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                // Badges
                let typeClass = item.Type === 'โครงการ' ? 'bg-blue-100 text-blue-800' : (item.Type === 'ครุภัณฑ์' ? 'bg-orange-100 text-orange-800' : 'bg-slate-100 text-slate-800');
                let statusColor = item.StatusGroup === 'completed' ? 'text-emerald-600 bg-emerald-50' : (item.StatusGroup === 'ongoing' ? 'text-amber-600 bg-amber-50' : 'text-slate-400 bg-slate-50');
                let statusIcon = item.StatusGroup === 'completed' ? 'fa-check-circle' : (item.StatusGroup === 'ongoing' ? 'fa-spinner fa-spin' : 'fa-clock');

                // Main Row
                const trMain = `
                    <tr class="cursor-pointer hover:bg-slate-50 transition-all border-b border-slate-100 group" onclick="toggleRow(${item.id})">
                        <td class="px-6 py-4"><span class="${typeClass} px-2 py-1 rounded text-[10px] font-bold border border-slate-200">${item.Type}</span></td>
                        <td class="px-6 py-4 font-semibold text-slate-700 group-hover:text-blue-600">${item.ProjectName}</td>
                        <td class="px-6 py-4 text-slate-500 text-xs">${item.Department}</td>
                        <td class="px-6 py-4 text-right font-mono text-slate-600">${item.BudgetVal.toLocaleString()}</td>
                        <td class="px-6 py-4 text-right font-mono text-slate-600">${item.SpentVal.toLocaleString()}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="${statusColor} px-3 py-1 rounded-full text-xs font-medium inline-flex items-center gap-1">
                                <i class="fa-solid ${statusIcon}"></i> ${item.DisplayStatus}
                            </span>
                        </td>
                        <td class="px-2 py-4 text-center text-slate-300 group-hover:text-blue-500">
                            <i id="icon-${item.id}" class="fa-solid fa-chevron-down transition-transform duration-300"></i>
                        </td>
                    </tr>
                `;

                // Detail Row (Hidden by default)
                const problemSection = (item.Problems && item.Problems !== "-" && item.Problems.trim() !== "") 
                    ? `<div class="mt-3 p-3 bg-red-50 border border-red-100 rounded-lg">
                         <strong class="text-red-700 text-xs flex items-center gap-1"><i class="fa-solid fa-triangle-exclamation"></i> ปัญหา/อุปสรรค:</strong>
                         <p class="text-slate-700 text-sm mt-1 pl-4">${item.Problems}</p>
                       </div>`
                    : ``;

                const trDetail = `
                    <tr id="detail-${item.id}" class="hidden-row bg-slate-50/50 shadow-inner">
                        <td colspan="7" class="px-6 py-4 border-b border-slate-200">
                            <div class="ml-2 pl-4 border-l-4 border-blue-200">
                                <div class="mb-2">
                                    <strong class="text-slate-500 text-xs uppercase tracking-wider">รายละเอียดการดำเนินงาน (แบบย่อ):</strong>
                                    <p class="text-slate-700 mt-1 leading-relaxed">${item.Details}</p>
                                </div>
                                ${problemSection}
                            </div>
                        </td>
                    </tr>
                `;
                
                tbody.insertAdjacentHTML('beforeend', trMain + trDetail);
            });

            renderCharts(data);
        }

        // --- 3. Interaction: Accordion ---
        function toggleRow(id) {
            const detailRow = document.getElementById(`detail-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            
            if (detailRow.style.display === "table-row") {
                detailRow.style.display = "none";
                icon.classList.remove("rotate-180");
            } else {
                detailRow.style.display = "table-row";
                icon.classList.add("rotate-180");
                detailRow.classList.add("fade-in");
            }
        }

        function resetFilters() {
            document.getElementById('filterType').value = 'all';
            document.getElementById('filterDept').value = 'all';
            document.getElementById('filterStatus').value = 'all';
            applyFilters();
        }

        function setupDropdowns(data) {
            const depts = [...new Set(data.map(item => item.Department))].filter(d => d).sort();
            const deptSelect = document.getElementById('filterDept');
            
            // Keep current selection if possible
            const currentVal = deptSelect.value;

            deptSelect.innerHTML = '<option value="all">ทุกหน่วยงาน</option>';
            depts.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
            
            // Restore selection if needed (not strict requirement but good UX)
            // But usually this runs on new file load, so reset is better.
        }

        // --- 4. Charts ---
        function renderCharts(data) {
            const statusCounts = { completed: 0, ongoing: 0, pending: 0 };
            data.forEach(d => statusCounts[d.StatusGroup]++);

            const deptBudget = {};
            data.forEach(d => {
                if (!deptBudget[d.Department]) deptBudget[d.Department] = 0;
                deptBudget[d.Department] += d.BudgetVal;
            });
            const sortedDept = Object.entries(deptBudget).sort((a,b) => b[1] - a[1]).slice(0, 5);

            const ctxStatus = document.getElementById('chartStatus').getContext('2d');
            const ctxDept = document.getElementById('chartDept').getContext('2d');

            if (chartStatusInstance) chartStatusInstance.destroy();
            chartStatusInstance = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['เสร็จสิ้น', 'กำลังดำเนินงาน', 'ยังไม่เริ่ม'],
                    datasets: [{
                        data: [statusCounts.completed, statusCounts.ongoing, statusCounts.pending],
                        backgroundColor: ['#10B981', '#F59E0B', '#CBD5E1'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: 'Sarabun' } } } } }
            });

            if (chartDeptInstance) chartDeptInstance.destroy();
            chartDeptInstance = new Chart(ctxDept, {
                type: 'bar',
                data: {
                    labels: sortedDept.map(d => d[0]),
                    datasets: [{
                        label: 'งบประมาณ',
                        data: sortedDept.map(d => d[1]),
                        backgroundColor: '#3B82F6',
                        borderRadius: 4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { 
                        y: { beginAtZero: true, grid: { borderDash: [2, 4] } }, 
                        x: { grid: { display: false }, ticks: { font: { family: 'Sarabun' } } } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- 5. CSV Upload ---
        document.getElementById('csvUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allData = processData(results.data);
                        setupDropdowns(allData);
                        applyFilters(); // Trigger update
                        alert("อัปเดตข้อมูลสำเร็จ!");
                    }
                }
            });
        });

        // --- Init ---
        window.onload = function() {
            allData = processData(initialRawData);
            setupDropdowns(allData);
            applyFilters();
        };
    </script>
</body>
</html>